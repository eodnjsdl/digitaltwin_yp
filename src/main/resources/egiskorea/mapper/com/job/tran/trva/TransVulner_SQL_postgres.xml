<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="transportationVulnerabilityDAO">
	<!-- 대중교통 취약 분석 목록 모두조회 : 리 -->
	<select id="selectTransportationVulnerabilityListAllLi" resultType="egovMap" parameterType="egiskorea.com.job.tran.trva.service.TransportationVulnerabilityVO">
		/* 대중교통 취약분석 - transportationVulnerabilityDAO.selectTransportationVulnerabilityListAllLi*/
		SELECT
			li_cd
			,stdr_ym
			,all_popltn_cnt
			,male_popltn_cnt
			,female_popltn_cnt
			,st_astext(geom) as geom
		FROM 
			tgd_li_popltn_info
		WHERE 1=1
		AND	stdr_ym = #{stdrYm}
		<if test="searchArea != '' ">
		AND 	
			li_cd like concat(substring(#{searchArea},1,8),'%')
		</if>
	</select>
	
	<!-- 중심점 : 리 -->
	<select id="getTransVulnerGeomCenterPos" resultType="egovMap" parameterType="egiskorea.com.job.tran.trva.service.TransportationVulnerabilityVO">
		/* 대중교통 취약분석 - transportationVulnerabilityDAO.getTransVulnerGeomCenterPos*/
		SELECT 
			st_astext(st_centroid(st_union(geom))) as geomCenter
		FROM 
			tgd_li_popltn_info
		WHERE 1=1
		AND	stdr_ym = #{stdrYm}
		<if test="searchArea != '' ">
		AND 	
			li_cd like concat(substring(#{searchArea},1,8),'%')
		</if>
	</select>
	
	<!-- 대중교통 취약 분석 목록 모두조회 : 격자 -->
	<select id="selectTransportationVulnerabilityListAllGrid" resultType="egovMap" parameterType="egiskorea.com.job.tran.trva.service.TransportationVulnerabilityVO">
		/* 대중교통 취약분석 - transportationVulnerabilityDAO.selectTransportationVulnerabilityListAllGrid*/
		<!-- SELECT
			grid_id
			,stdr_ym
			,all_popltn_cnt
			,male_popltn_cnt
			,female_popltn_cnt
			,st_astext(geom) as geom
		FROM 
			tgd_grid_popltn_info
		WHERE
			stdr_ym = #{stdrYm}
		LIMIT 10000 -->	
		SELECT
			(select code_nm from comtccmmndetailcode where code = r.hjd   and code_id = 'YPE001') as areaNm
			,(select code_nm from comtccmmndetailcode where code = r.li_cd and code_id = 'YPLI')   as liNm
		 	,r.*
		 FROM
		(		
			SELECT
				<!-- st_contains(li.geom, gd.geom) as bCon -->
				st_intersects(li.geom, gd.geom) as bCon
				,li.hjd
				,li.li_cd 
				,gd.grid_id
				,st_astext(gd.geom) as geom 
			FROM
			(
				SELECT
					li_cd
					,concat(substring(li_cd,1,8),'00') as hjd
					,stdr_ym
					,geom
				FROM 
					tgd_li_popltn_info
				WHERE 1=1
				AND	stdr_ym = #{stdrYm}
				<if test="searchArea != '' ">
				AND 	
					li_cd like concat(substring(#{searchArea},1,8),'%')
				</if>
			) li
			,
			(
				SELECT
					grid_id
					,stdr_ym
					,geom
				FROM 
					tgd_grid_popltn_info 
				WHERE 1=1
				AND	stdr_ym = #{stdrYm}
			) gd
		) r
		WHERE 1=1
		AND bCon = true
	</select>
	
	<!-- 대중교통 취약 분석 목록 조회 -->
	<select id="selectTransportationVulnerabilityList" resultType="egovMap" parameterType="egiskorea.com.job.tran.trva.service.TransportationVulnerabilityVO">
		/* 대중교통 취약분석 - transportationVulnerabilityDAO.selectTransportationVulnerabilityList*/
		SELECT
			li_cd
			,stdr_ym
			,all_popltn_cnt
			,male_popltn_cnt
			,female_popltn_cnt
			<!-- ,st_astext(ST_Transform(geom, 4326)) as geom -->
			,st_astext(geom) as geom
		FROM 
			tgd_li_popltn_info
	</select>

	<!-- 기준연월 조회 -->
	<select id="getTransVulnerBaseYMList" resultType="egovMap" parameterType="egiskorea.com.job.tran.trva.service.TransportationVulnerabilityVO">
		/* 대중교통 취약분석 - transportationVulnerabilityDAO.getTransVulnerBaseYMList*/
		SELECT
			DISTINCT  stdr_ym
		FROM 
			tgd_li_popltn_info
		ORDER BY stdr_ym DESC
	</select>
</mapper>